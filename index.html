<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ngaleueut</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="icon" type="image/png" href="img/icon.png" />
    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <header>
      <img src="img/icon.png" width="50px" height="auto" alt="" />
      <h1>Ngaleueut</h1>
      <nav>
        <ul>
          <li><a href="#beranda">Beranda</a></li>
          <li><a href="#menu">Menu</a></li>
          <li style="position:relative;"><a href="#keranjang"><i class="fa fa-shopping-cart"></i> <span id="cart-badge" style="display:none; position:absolute; top:-10px; right:-10px; background:red; color:white; border-radius:50%; padding:2px 6px; font-size:12px;"></span></a></li>
        </ul>
      </nav>
    </header>

    <section class="hero" id="beranda">
      <div class="hero-text">
        <h2>Nikmati Nyalsemu dengan <span>Ngaleueut</span></h2>
        <p>
          Nikmati sensasi segar dan pedas dalam satu tempat. Pesan sekarang dan
          rasakan kenikmatannya!
        </p>
        <a href="#menu" class="btn">Pesan Sekarang</a>
      </div>
      <img src="img/heromenu.png" alt="Hero Menu" />
    </section>

    <section class="products" id="menu">
      <h2>Menu Kami</h2>

      <h3>Makanan</h3>
      <div class="grid" id="makanan"></div>
      <h3>Minuman</h3>
      <div class="grid" id="minuman"></div>
      <h3>Paket</h3>
      <div class="grid" id="paket"></div>

      <!-- Keranjang -->
      <div class="cart" id="keranjang">
        <h2 >Keranjang Pesanan</h2>
        <ul id="cart-items"></ul>
        <p class="total">Subtotal: Rp<span id="subtotal">0</span></p>
        <p class="total">Ongkos Kirim: Rp<span id="ongkir">0</span></p>
        <p class="total">Total: Rp<span id="total">0</span></p>
        <div style="margin:10px 0; text-align:left; margin-left: 20px;">
          <label for="nama-pembeli" style="font-weight:bold;">Nama Pembeli:</label><br>
          <input type="text" id="nama-pembeli" placeholder="Masukkan nama pembeli" style="padding:5px; border-radius:5px; border:1px solid #ccc; width:200px; margin-top:5px;">
        </div>
        <div style="margin:10px 0; text-align:left; margin-left: 20px;">
          <label for="catatan-pembeli" style="font-weight:bold;">Catatan Pembeli:</label><br>
          <textarea id="catatan-pembeli" placeholder="Masukkan catatan jika ada" style="padding:5px; border-radius:5px; border:1px solid #ccc; width:200px; height:60px; margin-top:5px;"></textarea>
        </div>
        <div style="margin:10px 0; text-align:left; margin-left: 20px;">
          <input type="checkbox" id="delivery-checkbox" style="margin-right:5px;">
          <label for="delivery-checkbox" style="font-weight:bold;">Delivery</label>
        </div>
        <div id="address-form" style="margin:10px 0; text-align:left; margin-left: 20px; display:none;">
          <label for="alamat-pengiriman" style="font-weight:bold;">Alamat Pengiriman:</label><br>
          <textarea id="alamat-pengiriman" placeholder="Masukkan alamat lengkap pengiriman" style="padding:5px; border-radius:5px; border:1px solid #ccc; width:200px; height:60px; margin-top:5px;"></textarea>
        </div>
        <div id="map"></div>
        <div
          class="info"
          id="hasil"
          style="margin-top: 10px; text-align: center"
        ></div>
        <button class="btn" style="background:#25D366; color:#fff;" onclick="checkout()">
          <i class="fab fa-whatsapp" style="margin-right:6px;"></i>Pesan via WhatsApp
        </button>
      </div>
    </section>

    <footer>
      <p>Â© 2025 Ngaleueut - Ngopi nyalse!</p>
    </footer>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
      const booth = [-6.879417, 108.289361]; // Lokasi booth
      let ongkir = 0;
      let jarakKm = 0;

      const products = {
        makanan: [
          {
            id: 1,
            name: "Mie Level",
            price: { Small: 5000, Large: 8000 },
            img: "img/miejontor.png",
            isSpicy: true,
            rating: 4.5,
            toppings: [ { name: "Bakso Kecil", price: 1000 },{ name: "Pangsit Ayam", price: 1000 }, { name: "Bakso Besar", price: 5000 },{ name: "Sosis Mekar", price: 5000 }, { name: "Sosis Mekar Pedas", price: 5000 }, { name: "Telor", price: 3000 } ],
          },
          {
            id: 2,
            name: "Pangsit Ayam",
            price: { Small: 5000, Large: 10000 },
            isSpicy: true,
            img: "img/pangyam.png",
            rating: 4.5,
          },
          {
            id: 3,
            name: "Bakso Mekar Pedas",
            price: { Small: 5000, Large: 10000 },
            img: "img/bakso-mekar.png",
            isSpicy: true,
            rating: 4.2,
          },
          {
            id: 4,
            name: "Sosis Mekar Pedas",
            price: { Small: 5000, Large: 10000 },
            img: "img/sosis.png",
            isSpicy: true,
            rating: 4.1,
          },
          {
            id: 5,
            name: "Basreng Chili Oil",
            price: { Small: 5000, Large: 10000 },
            img: "img/basreng.png   ",
            isSpicy: true,
            rating: 4,
          },
          {
            id: 6,
            name: "Cimol Bojot",
            price: { Small: 5000, Large: 10000 },
            img: "img/cimol.png",
            isSpicy: true,
            rating: 4.5,
          },
          {
            id: 7,
            name: "Churros",
            price: { Small: 5000, Large: 10000 },
            img: "img/churros.png",
            sauces: ["Cokelat", "Strawberry", "Matcha"],
            isSpicy: false,
            rating: 4.3,
          },
          {
            id: 8,
            name: "Minipao Goreng",
            price: { Small: 5000, Large: 10000 },
            img: "img/minipao.png",
            isSpicy: false,
            rating: 4,
          },
          {
            id: 9,
            name: "Sosis / Bakso Crispy",
            price: 0,
            img: "img/sosis-crispy.png",
            toppings: [ { name: "Sosis Crispy", price: 1000 }, { name: "Bakso Crispy", price: 1000 } ],
            rating: 3.8,
          },
          {
            id: 10,
            name: "Indomie Goreng / Rebus",
            price: { Small: 5000 },
            img: "img/indomie-rebus.png",
            isSpicy: true,
            toppings: [ { name: "Bakso Kecil", price: 1000 },{ name: "Pangsit Ayam", price: 1000 }, { name: "Bakso Besar", price: 5000 },{ name: "Sosis Mekar", price: 5000 }, { name: "Sosis Mekar Pedas", price: 5000 }, { name: "Telor", price: 3000 } ],
            rating: 3.9,
          },
        ],
        minuman: [
          {
            id: 11,
            name: "Milky Coffe",
            price: { Small: 7000, Medium: 9000, Large: 11000 },
            img: "img/milky-coffe.png",
            toppings: [ { name: "Boba", price: 1000 }, { name: "Jelly", price: 1000 }, ],
            rating: 4.2,
          },
          {
            id: 12,
            name: "Americano",
            price: { Small: 6000, Medium: 8000, Large: 10000 },
            img: "img/black-coffe.png",
            toppings: [ { name: "Boba", price: 1000 }, { name: "Jelly", price: 1000 }, ],
            rating: 4,
          },
          {
            id: 13,
            name: "Coffe Gula Aren",
            price: { Small: 7500, Medium: 10000, Large: 11000 },
            img: "img/coffe-gula-aren.png",
            toppings: [ { name: "Boba", price: 1000 }, { name: "Jelly", price: 1000 }, ],
            rating: 4.1,
          },
          {
            id: 14,
            name: "Matcha Tjih",
            price: { Small: 8000, Medium: 11000, Large: 12000 },
            img: "img/matcha-tjih.png",
            toppings: [ { name: "Boba", price: 1000 }, { name: "Jelly", price: 1000 }, ],
            rating: 4.6,
          },
          {
            id: 15,
            name: "Thai Tea",
            price: { Small: 7000, Medium: 9000, Large: 11000 },
            img: "img/Thai-tea.png",
            toppings: [ { name: "Boba", price: 1000 }, { name: "Jelly", price: 1000 }, ],
            rating: 4.1,
          },
          {
            id: 16,
            name: "Choco BengBeng",
            price: { Small: 8500, Medium: 11000, Large: 13000 },
            img: "img/benbeng.png",
            toppings: [ { name: "Boba", price: 1000 }, { name: "Jelly", price: 1000 }, ],
            rating: 4.6,
          },
          {
            id: 17,
            name: "Milo Ice",
            price: { Small: 7000, Medium: 9000, Large: 11000 },
            img: "img/milo-ice.png",
            toppings: [ { name: "Boba", price: 1000 }, { name: "Jelly", price: 1000 }, ],
            rating: 4,
          },
          {
            id: 18,
            name:   "Milky Strawberry",
            price: { Small: 6000, Medium: 9000, Large: 11000 },
            img: "img/strawberry.png",
            toppings: [ { name: "Boba", price: 1000 }, { name: "Jelly", price: 1000 }, ],
            rating: 4.3,
          },
          {
            id: 19,
            name: "Milky Taro",
            price: { Small: 6000, Medium: 9000, Large: 11000 },
            img: "img/milky-taro.png",
            toppings: [ { name: "Boba", price: 1000 }, { name: "Jelly", price: 1000 }, ],
            rating: 4.4,
          },
          {
            id: 20,
            name: "Milky Buble Gum",
            price: { Small: 6000, Medium: 9000, Large: 11000 },
            img: "img/milky-buble-gum.png",
            toppings: [ { name: "Boba", price: 1000 }, { name: "Jelly", price: 1000 }, ],
            rating: 4,
          },
          {
            id: 21,
            name: "Original Tea",
            price: { Small: 2000, Large: 3500 },
            img: "img/tea original.png",
            toppings: [ { name: "Boba", price: 1000 }, { name: "Jelly", price: 1000 }, ],
            rating: 4.1,
          },
        ],
        paket: [
          {
            id: 22,
            name: "Paket Ngaleueut Nyalira",
            price: 10000,
            img: "img/ngaleueut-nyalira.png", // Placeholder image
            choices: {
              minuman: ["Milky Taro Small", "Milky Bubble Gum Small", "Milky Strawberry Small"],
              makanan: ["Mie Small", "Pangsit Ayam Small"]
            },
            isSpicy: true, // For Mie or Pangsit
            rating: 4.5
          },
          {
            id: 23,
            name: "Paket Setelan Ceban",
            price: 10000,
            img: "img/setelan-ceban.png", // Placeholder
            fixed: {
              makanan: "Mie Large",
              topping: "Pangsit Ayam",
              minuman: "Original Tea Small"
            },
            isSpicy: true, // For Mie
            rating: 4.5
          },
          {
            id: 24,
            name: "Paket Nyalse Tipis-Tipis",
            price: 11000,
            img: "img/nyalse-tipis-tipis.png", // Placeholder
            choices: {
              makanan: ["Churros Small", "Minipao Goreng Small"],
              minuman: ["Coffe Gula Aren Small"]
            },
            sauces: ["Cokelat", "Matcha", "Strawberry"], // Only if Churros
            rating: 4
          },
          {
            id: 25,
            name: "Paket Ngidam Pedes Manis",
            price: 13000,
            img: "img/ngidam-pedes-manis.png", // Placeholder
            choices: {
              makanan: ["Basreng Chili Oil Small", "Cimol Bojot Small"],
              minuman: ["Thai Tea Medium"]
            },
            isSpicy: true, // For Basreng or Cimol
            rating: 3.5
          },
          {
            id: 26,
            name: "Paket Bestie Pedes Manis",
            price: 21000,
            img: "img/bestie-pedes-manis.png", // Placeholder
            choices: {
              minuman1: ["Milky Taro Small", "Milky Bubble Gum Small", "Milky Strawberry Small"],
              minuman2: ["Milky Taro Small", "Milky Bubble Gum Small", "Milky Strawberry Small"],
              makanan: ["Cimol Bojot Large", "Basreng Chili Oil Large"]
            },
            isSpicy: true, // For Cimol or Basreng
            rating: 4
          },
          {
            id: 27,
            name: "Paket Ngaleueut Duo",
            price: 25000,
            img: "img/ngaleueut-duo.png", // Placeholder
            choices: {
              makanan: ["Cimol Bojot Small", "Basreng Chili Oil Small"]
            },
            fixed: {
              minuman1: "Matcha Tjih Small",
              minuman2: "Choco BengBeng Small",
              mie: "Mie Small"
            },
            isSpicy: true, // For Cimol/Basreng/Mie
            rating: 4
          }
        ]
      };

      let cart = [];
      let promoUsed = localStorage.getItem("ngaleueut_promo_used") === "1";
      let promoApplied = false;
      let promoDiscount = 0;
      let shippingPromoUsed = localStorage.getItem("ngaleueut_shipping_promo_used") === "1";
      let shippingPromoApplied = false;
      let shippingDiscount = 0;

      // Tambahkan elemen promo form setelah DOMContentLoaded
      function renderPromoForm() {
        const cartDiv = document.querySelector(".cart");
        // Cek jika sudah ada, jangan tambah dua kali
        if (document.getElementById("promo-form")) return;
        const promoDiv = document.createElement("div");
        promoDiv.id = "promo-form";
        promoDiv.style = "margin:18px 0 10px 0;text-align:center;";
        promoDiv.innerHTML = `
          <input type="text" id="promo-code" placeholder="Masukkan kode promo" style="padding:7px 10px;border-radius:6px;border:1px solid #ccc;width:60%;max-width:220px;">
          <button class="btn" id="apply-promo" style="margin-left:8px;background:#ff9800;color:#fff;">Gunakan</button>
          <div id="promo-info" style="margin-top:7px;font-size:15px;min-height:22px;"></div>
        `;
        // Sisipkan sebelum map
        const mapDiv = document.getElementById("map");
        cartDiv.insertBefore(promoDiv, mapDiv);
        document.getElementById("apply-promo").onclick = applyPromo;
      }

      function applyPromo() {
        const code = document.getElementById("promo-code").value.trim().toUpperCase();
        const info = document.getElementById("promo-info");
        if (code === "WKWKWK") {
          if (promoUsed) {
        info.innerHTML = `<span style="color:#e53935;">Mohon maaf, kode promo tersebut sudah dipakai.</span>`;
        promoApplied = false;
        promoDiscount = 0;
        shippingPromoApplied = false;
        shippingDiscount = 0;
          } else {
        // Cek subtotal
        let subtotal = cart.reduce((sum, item) => sum + item.price * item.qty, 0);
        if (subtotal > 20000) {
          promoApplied = true;
          promoDiscount = Math.round(subtotal * 0.1);
          info.innerHTML = `<span style="color:#388e3c;">Promo launching website Ngaleueut! Berlaku sampai tanggal 25 September 2025. Potongan 10% sudah diterapkan.</span>`;
          localStorage.setItem("ngaleueut_promo_used", "1");
          promoUsed = true;
          shippingPromoApplied = false;
          shippingDiscount = 0;
        } else {
          info.innerHTML = `<span style="color:#e53935;">Minimal belanja Rp20.000 untuk menggunakan promo ini.</span>`;
          promoApplied = false;
          promoDiscount = 0;
          shippingPromoApplied = false;
          shippingDiscount = 0;
        }
          }
        } else if (code === "NGALEUEUT2025") {
          // Admin code, bisa dipakai berkali-kali
          let subtotal = cart.reduce((sum, item) => sum + item.price * item.qty, 0);
          if (subtotal > 20000) {
        promoApplied = true;
        promoDiscount = Math.round(subtotal * 0.1);
        info.innerHTML = `<span style="color:#388e3c;">Kode admin: Potongan 10% sudah diterapkan (NGALEUEUT2025).</span>`;
        shippingPromoApplied = false;
        shippingDiscount = 0;
          } else {
        info.innerHTML = `<span style="color:#e53935;">Minimal belanja Rp20.000 untuk menggunakan promo ini.</span>`;
        promoApplied = false;
        promoDiscount = 0;
        shippingPromoApplied = false;
        shippingDiscount = 0;
          }
        } else if (code === "DUABULAN") {
          // Promo ongkir 50% max 20k
          if (shippingPromoUsed) {
            info.innerHTML = `<span style="color:#e53935;">Mohon maaf, kode promo tersebut sudah dipakai.</span>`;
            shippingPromoApplied = false;
            shippingDiscount = 0;
          } else {
            let subtotal = cart.reduce((sum, item) => sum + item.price * item.qty, 0);
            let ongkirTemp = hitungOngkir(jarakKm, subtotal);
            let discount = Math.min(Math.round(ongkirTemp * 0.5), 20000);
            // Konfirmasi dengan pop-up
            if (confirm(`Apakah Anda ingin menggunakan promo ongkir 50% (max Rp20.000)?\nPotongan: Rp${discount.toLocaleString("id-ID")}`)) {
              shippingPromoApplied = true;
              shippingDiscount = discount;
              info.innerHTML = `<span style="color:#388e3c;">Promo ongkir 50% (max Rp20.000) sudah diterapkan.</span>`;
              promoApplied = false;
              promoDiscount = 0;
              localStorage.setItem("ngaleueut_shipping_promo_used", "1");
              shippingPromoUsed = true;
              // Pop-up selamat
              alert(`Selamat! Anda telah mendapatkan potongan harga ongkir sebesar Rp${discount.toLocaleString("id-ID")}`);
            } else {
              info.innerHTML = "";
              promoApplied = false;
              promoDiscount = 0;
              shippingPromoApplied = false;
              shippingDiscount = 0;
            }
          }
        } else if (code.length > 0) {
          info.innerHTML = `<span style="color:#e53935;">Kode tersebut tidak dapat digunakan.</span>`;
          promoApplied = false;
          promoDiscount = 0;
          shippingPromoApplied = false;
          shippingDiscount = 0;
        } else {
          info.innerHTML = "";
          promoApplied = false;
          promoDiscount = 0;
          shippingPromoApplied = false;
          shippingDiscount = 0;
        }
        renderCart();
      }



      function generateStars(rating) {
        let stars = '';
        for (let i = 1; i <= 5; i++) {
          if (i <= Math.floor(rating)) {
            stars += '<i class="fas fa-star"></i>';
          } else if (i === Math.ceil(rating) && rating % 1 !== 0) {
            stars += '<i class="fas fa-star-half-alt"></i>';
          } else {
            stars += '<i class="far fa-star"></i>';
          }
        }
        return stars;
      }

      function decrease(id, idx) {
        const qtyEl = document.getElementById(`qty-${id}-${idx}`);
        let qty = parseInt(qtyEl.textContent) || 0;
        if (qty > 0) {
          qty--;
          qtyEl.textContent = qty;
        }
      }

      function increase(id, idx) {
        const qtyEl = document.getElementById(`qty-${id}-${idx}`);
        let qty = parseInt(qtyEl.textContent) || 0;
        if (qty < 10) {
          qty++;
          qtyEl.textContent = qty;
        }
      }

      function renderProducts() {
        for (let category in products) {
          const container = document.getElementById(category);
          products[category].forEach((p) => {
            const div = document.createElement("div");
            div.className = "product";
            let options = "";
            for (let variant in p.price) {
              options += `<option value="${variant}">${variant} - Rp${p.price[
                variant
              ].toLocaleString("id-ID")}</option>`;
            }
            // Tambahkan select level jika kategori makanan dan isSpicy true
            let levelSelect = "";
            if (category === "makanan" && p.isSpicy === true) {
              levelSelect = `
              <select id="level-${p.id}">
                <option value="" disabled selected>Pilih level pedas</option>
                <option value="0">Tanpa pedas</option>
                <option value="1">Level 1</option>
                <option value="2">Level 2</option>
                <option value="3">Level 3</option>
                <option value="4">Level 4 (+Rp1.000)</option>
                <option value="5">Level 5 (+Rp1.000)</option>
                <option value="6">Pedas dipisah (+Rp500)</option>
              </select>
              `;
            }
            // Tambahkan select toppings jika ada
            let toppingsSelect = "";
            if (p.toppings && p.toppings.length > 0) {
            if (p.id === 1 || p.id === 9 || p.id === 10) {
                // For Mie Level, Sosis/Bakso Crispy, and Indomie, use checkboxes and +/- buttons for quantity
                let toppingsHtml = '<div id="toppings-' + p.id + '" style="margin:5px 0; text-align:left;">';
                toppingsHtml += '<p style="margin:0 0 5px 0; font-size:14px;">' + (p.id === 9 ? 'Pilih Varian:' : 'Pilih Toppings:') + '</p>';
                p.toppings.forEach((t, idx) => {
                  toppingsHtml += `
                    <div style="display:flex; align-items:center; margin-bottom:2px;">
                      <input type="checkbox" id="topping-check-${p.id}-${idx}" style="margin-right:5px;">
                      <label for="topping-check-${p.id}-${idx}" style="flex:1; font-size:12px;">${t.name} (+Rp${t.price.toLocaleString("id-ID")})</label>
                      <button onclick="decrease(${p.id}, ${idx})" style="width:20px; height:20px; padding:0; font-size:12px; margin-left:5px;">-</button>
                      <span id="qty-${p.id}-${idx}" style="margin:0 5px; font-size:12px;">0</span>
                      <button onclick="increase(${p.id}, ${idx})" style="width:20px; height:20px; padding:0; font-size:12px;">+</button>
                    </div>
                  `;
                });
                toppingsHtml += '</div>';
                toppingsSelect = toppingsHtml;
              } else {
                let toppingOptions = `<option value="">Tanpa topping</option>`;
                p.toppings.forEach(t => {
                  toppingOptions += `<option value="${t.name}">${t.name} (+Rp${t.price.toLocaleString("id-ID")})</option>`;
                });
                toppingsSelect = `<select id="toppings-${p.id}" style="margin:5px 0;">${toppingOptions}</select>`;
              }
            }
      // Tambahkan select sauce jika ada
      let sauceSelect = "";
      if (p.sauces && p.sauces.length > 0) {
        let sauceOptions = `<option value="">Tanpa sauce</option>`;
        p.sauces.forEach(s => {
          sauceOptions += `<option value="${s}">${s}</option>`;
        });
        sauceSelect = `<select id="sauce-${p.id}" style="margin:5px 0;">${sauceOptions}</select>`;
      }
      // Tambahkan select method untuk Pangsit Ayam
      let methodSelect = "";
      if (p.id === 2) {
        methodSelect = `<select id="method-${p.id}" style="margin:5px 0;"><option value="">Pilih metode</option><option value="Direbus">Direbus</option><option value="Digoreng">Digoreng</option></select>`;
      }
      // Tambahkan select kuah untuk Pangsit Ayam, Bakso Mekar, dan Sosis Mekar Pedas
      let kuahSelect = "";
      if (p.id === 2 || p.id === 3 ) {
        kuahSelect = `<select id="kuah-${p.id}" style="margin:5px 0;"><option value="">Pilih kuah</option><option value="ya">Ya (+Rp1.000)</option><option value="tidak">Tidak</option></select>`;
      }
            if (category === "paket") {
              // Paket specific
              let choicesSelect = "";
              if (p.choices) {
                for (let key in p.choices) {
                  let opts = `<option value="">Pilih ${key}</option>`;
                  p.choices[key].forEach(opt => opts += `<option value="${opt}">${opt}</option>`);
                  choicesSelect += `<select id="${key}-${p.id}" style="margin:5px 0;">${opts}</select>`;
                }
              }
              let fixedText = "";
              if (p.fixed) {
                fixedText = "<p style='font-size:14px; margin-left:10px;'>Isi paket:</p><ul style='text-align:left; font-size:12px; margin-left:20px;'>";
                for (let key in p.fixed) {
                  fixedText += `<li>${key}: ${p.fixed[key]}</li>`;
                }
                fixedText += "</ul>";
              }
              let sauceSelectPaket = "";
              if (p.sauces) {
                let opts = `<option value="">Tanpa sauce</option>`;
                p.sauces.forEach(s => opts += `<option value="${s}">${s}</option>`);
                sauceSelectPaket = `<select id="sauce-${p.id}" style="margin:5px 0;">${opts}</select>`;
              }
              let levelSelectPaket = "";
              if (p.isSpicy) {
                levelSelectPaket = `
                <select id="level-${p.id}">
                  <option value="" disabled selected>Pilih level pedas</option>
                  <option value="0">Tanpa pedas</option>
                  <option value="1">Level 1</option>
                  <option value="2">Level 2</option>
                  <option value="3">Level 3</option>
                  <option value="4">Level 4 (+Rp1.000)</option>
                  <option value="5">Level 5 (+Rp1.000)</option>
                  <option value="6">Pedas dipisah (+Rp500)</option>
                </select>
                `;
              }
              div.innerHTML = `
                <img src="${p.img}" alt="${p.name}">
                <h3>${p.name}</h3>
                <div class="rating">${generateStars(p.rating)}</div>
                <p>Harga: Rp${p.price.toLocaleString("id-ID")}</p>
                ${fixedText}
                ${choicesSelect}
                ${sauceSelectPaket}
                ${levelSelectPaket}
                <button class="btn" onclick="addToCart(${p.id}, '${category}')"><i class="fa fa-shopping-cart"></i> Tambah</button>
              `;
            } else {
              // Makanan and minuman
              div.innerHTML = `
                <img src="${p.img}" alt="${p.name}">
                <h3>${p.name}</h3>
                <div class="rating">${generateStars(p.rating)}</div>
                ${typeof p.price === 'object' ? `<select id="variant-${p.id}">${options}</select>` : ''}
                ${levelSelect}
                ${toppingsSelect}
                ${sauceSelect}
                ${methodSelect}
                ${kuahSelect}
                <button class="btn" onclick="addToCart(${p.id}, '${category}')"><i class="fa fa-shopping-cart"></i> Tambah</button>
              `;
            }
            container.appendChild(div);
          });
        }
        // Kuah for Pangsit Ayam is always shown after method
      }

      function addToCart(id, category) {
        const product = products[category].find((p) => p.id === id);
        let price = product.price;
        let level = null;
        let choices = {};
        let fixed = product.fixed || {};
        let toppings = [];
        let sauce = "";
        let variant = "";

        if (category === "paket") {
          // For paket, price is fixed, get choices, level, sauce
          if (product.choices) {
            for (let key in product.choices) {
              const selectEl = document.getElementById(`${key}-${id}`);
              if (selectEl) {
                const val = selectEl.value;
                if (val === "") {
                  alert(`Pilih ${key} terlebih dahulu!`);
                  return;
                }
                choices[key] = val;
              }
            }
          }
          if (product.isSpicy) {
            level = document.getElementById(`level-${id}`).value;
            if (level === "") {
              alert("Pilih level pedas terlebih dahulu!");
              return;
            }
          }
          if (product.sauces) {
            sauce = document.getElementById(`sauce-${id}`).value;
          }
        } else {
          // Makanan or minuman
          const variantEl = document.getElementById(`variant-${id}`);
          variant = variantEl ? variantEl.value : '';
          if (typeof product.price === 'object') {
            price = product.price[variant];
          } else {
            price = product.price;
          }
          if (category === "makanan" && product.isSpicy === true) {
            level = document.getElementById(`level-${id}`).value;
            if (level === "") {
              alert("Pilih level pedas terlebih dahulu!");
              return;
            }
            if (level === "4" || level === "5") {
              price += 1000;
            }
            if (level === "6") {
              price += 500;
            }
          }
          // Ambil toppings jika ada
          if (product.toppings && product.toppings.length > 0) {
            if (id === 1 || id === 9 || id === 10) {
              // For Mie Level, Sosis/Bakso Crispy, and Indomie, get toppings from checkboxes and spans
              product.toppings.forEach((t, idx) => {
                const checkEl = document.getElementById(`topping-check-${id}-${idx}`);
                if (checkEl.checked) {
                  const qtyEl = document.getElementById(`qty-${id}-${idx}`);
                  const qty = parseInt(qtyEl.textContent) || 0;
                  if (qty > 0) {
                    toppings.push({ name: t.name, qty: qty, price: t.price });
                    price += t.price * qty;
                  }
                }
              });
            } else {
              const toppingsSelect = document.getElementById(`toppings-${id}`);
              const selectedOptions = Array.from(toppingsSelect.selectedOptions);
              selectedOptions.forEach(option => {
                if (option.value) {
                  const topping = product.toppings.find(t => t.name === option.value);
                  if (topping) {
                    toppings.push(topping.name);
                    price += topping.price;
                  }
                }
              });
            }
          }
          // Ambil sauce jika ada
          if (product.sauces && product.sauces.length > 0) {
            sauce = document.getElementById(`sauce-${id}`).value;
          }
          // Ambil kuah untuk Pangsit Ayam, Bakso Mekar, dan Sosis Mekar Pedas
          if (id === 2 || id === 3) {
            const kuah = document.getElementById(`kuah-${id}`).value;
            if (kuah === "") {
              alert("Pilih kuah terlebih dahulu!");
              return;
            }
            choices.kuah = kuah;
            if (kuah === "ya") {
              price += 1000;
            }
          }
          // Ambil metode untuk Pangsit Ayam
          if (id === 2) {
            const method = document.getElementById(`method-${id}`).value;
            if (method === "") {
              alert("Pilih metode masak terlebih dahulu!");
              return;
            }
            choices.method = method;
          }
        }

        // Cari item di cart
        const existing = cart.find(
          (item) => {
            if (item.id !== id) return false;
            if (item.variant !== variant) return false;
            if (item.level != level) return false;
            if (item.sauce !== sauce) return false;
            // Compare choices
            if (item.choices) {
              if (!choices || Object.keys(item.choices).length !== Object.keys(choices).length) return false;
              for (let k in choices) {
                if (item.choices[k] !== choices[k]) return false;
              }
            } else if (choices && Object.keys(choices).length > 0) return false;
            // Compare toppings
            if (!item.toppings || item.toppings.length !== toppings.length) return false;
            for (let i = 0; i < toppings.length; i++) {
              if (id === 1 || id === 9 || id === 10) {
                if (item.toppings[i].name !== toppings[i].name || item.toppings[i].qty !== toppings[i].qty) return false;
              } else {
                if (item.toppings[i] !== toppings[i]) return false;
              }
            }
            return true;
          }
        );
        if (existing) {
          existing.qty++;
        } else {
          const cartItem = { ...product, variant, price, qty: 1, sauce, choices, fixed };
          if (category === "makanan" || category === "paket") cartItem.level = level;
          if (id === 1 || id === 9 || id === 10) {
            cartItem.toppings = toppings; // array of {name, qty, price}
          } else {
            cartItem.toppings = toppings; // array of names
          }
          cart.push(cartItem);
        }
        renderCart();
      }

      function removeFromCart(index) {
        cart.splice(index, 1);
        renderCart();
      }

      function renderCart() {
        let cartList = document.getElementById("cart-items");
        let subtotalEl = document.getElementById("subtotal");
        let ongkirEl = document.getElementById("ongkir");
        let totalEl = document.getElementById("total");
        cartList.innerHTML = "";
        let subtotal = 0;
        cart.forEach((item, idx) => {
          let levelText = "";
          if (item.level) {
            if (item.level === "6") {
              levelText = ` [Pedas pisah]`;
            } else {
              levelText = ` [Level ${item.level}]`;
            }
          }
          let toppingsText = "";
          if (item.toppings && item.toppings.length > 0) {
            if (item.id === 1 || item.id === 9 || item.id === 10) {
              toppingsText = ` Toppings: ${item.toppings.map(t => `${t.name} x${t.qty}`).join(", ")}`;
            } else {
              toppingsText = ` Toppings: ${item.toppings.join(", ")}`;
            }
          }
          let sauceText = "";
          if (item.sauce) {
            sauceText = ` Sauce: ${item.sauce}`;
          }
          let variantText = item.variant ? ` [${item.variant}]` : "";
          let choicesText = "";
          if (item.choices) {
            if (item.id === 2) {
              choicesText = ` Kuah: ${item.choices.kuah}, Metode: ${item.choices.method}`;
            } else if (item.id === 3) {
              choicesText = ` Kuah: ${item.choices.kuah}`;
            } else {
              choicesText = ` Pilihan: ${Object.entries(item.choices).map(([k,v]) => `${k}: ${v}`).join(", ")}`;
            }
          }
          let fixedText = item.fixed ? ` ${Object.values(item.fixed).join(", ")}` : "";
          let li = document.createElement("li");
          li.innerHTML = `
            <span>${item.name}${levelText}${toppingsText}${sauceText}${variantText}${choicesText}${fixedText} ${item.qty} = Rp${(item.price * item.qty).toLocaleString("id-ID")}</span>
            <button onclick="removeFromCart(${idx})" style="background:none;border:none;color:#e53935;font-size:18px;cursor:pointer;float:right;" title="Hapus item">&times;</button>
          `;
          cartList.appendChild(li);
          subtotal += item.price * item.qty;
        });

        // Update cart badge
        let totalQty = cart.reduce((sum, item) => sum + item.qty, 0);
        const badge = document.getElementById("cart-badge");
        if (totalQty > 0) {
          badge.textContent = totalQty;
          badge.style.display = "inline";
        } else {
          badge.style.display = "none";
        }

        // Hitung ongkir berdasarkan subtotal
        ongkir = hitungOngkir(jarakKm, subtotal);

        if (shippingPromoApplied) {
          ongkir -= shippingDiscount;
        }

        // Hitung promo
        let discount = 0;
        if (promoApplied && subtotal > 20000) {
          discount = Math.round(subtotal * 0.1);
          promoDiscount = discount;
        } else {
          promoDiscount = 0;
        }

        // Tampilkan subtotal, diskon, ongkir, total
        subtotalEl.textContent = subtotal.toLocaleString("id-ID");
        ongkirEl.textContent = ongkir.toLocaleString("id-ID");
        // Tambahkan baris diskon jika promo aktif
        let promoRow = document.getElementById("promo-row");
        if (discount > 0) {
          if (!promoRow) {
            promoRow = document.createElement("p");
            promoRow.className = "total";
            promoRow.id = "promo-row";
            totalEl.parentNode.insertBefore(promoRow, totalEl);
          }
          promoRow.innerHTML = `Promo: -Rp<span id="promo-discount">${discount.toLocaleString("id-ID")}</span>`;
        } else if (promoRow) {
          promoRow.remove();
        }
        // Tambahkan baris shipping promo jika aktif
        let shippingPromoRow = document.getElementById("shipping-promo-row");
        if (shippingPromoApplied) {
          if (!shippingPromoRow) {
            shippingPromoRow = document.createElement("p");
            shippingPromoRow.className = "total";
            shippingPromoRow.id = "shipping-promo-row";
            totalEl.parentNode.insertBefore(shippingPromoRow, totalEl);
          }
          shippingPromoRow.innerHTML = `Shipping Promo: -Rp<span id="shipping-discount">${shippingDiscount.toLocaleString("id-ID")}</span>`;
        } else if (shippingPromoRow) {
          shippingPromoRow.remove();
        }
        totalEl.textContent = (subtotal + ongkir - discount).toLocaleString("id-ID");
      }

      let estimatedLocation = "";

      function checkout() {
        if (cart.length === 0) {
          alert("Keranjang masih kosong!");
          return;
        }
        let nama = document.getElementById("nama-pembeli").value.trim();
        let catatan = document.getElementById("catatan-pembeli").value.trim();
        let message = "Halo, saya " + nama + " ingin memesan:%0A";
        let subtotal = 0;
        cart.forEach((item) => {
          let levelText = "";
          if (item.level) {
            if (item.level === "6") {
              levelText = ` [dipisah]`;
            } else {
              levelText = ` [Level ${item.level}]`;
            }
          }
          let toppingsText = "";
          if (item.toppings && item.toppings.length > 0) {
            if (item.id === 1 || item.id === 9 || item.id === 10) {
              toppingsText = ` Toppings: ${item.toppings.map(t => `${t.name} x${t.qty}`).join(", ")}`;
            } else {
              toppingsText = ` Toppings: ${item.toppings.join(", ")}`;
            }
          }
          let sauceText = "";
          if (item.sauce) {
            sauceText = ` Sauce: ${item.sauce}`;
          }
          let variantText = item.variant ? ` [${item.variant}]` : "";
          let choicesText = "";
          if (item.choices) {
            if (item.id === 2) {
              choicesText = ` Kuah: ${item.choices.kuah}, Metode: ${item.choices.method}`;
            } else if (item.id === 3) {
              choicesText = ` Kuah: ${item.choices.kuah}`;
            } else {
              choicesText = ` Pilihan: ${Object.values(item.choices).join(", ")}`;
            }
          }
          let fixedText = item.fixed ? ` ${Object.values(item.fixed).join(", ")}` : "";
          message += `- ${item.name}${levelText}${toppingsText}${sauceText}${variantText}${choicesText}${fixedText} (x${
            item.qty
          }) = Rp${(item.price * item.qty).toLocaleString("id-ID")}%0A`;
          subtotal += item.price * item.qty;
        });
        let discount = promoApplied && subtotal > 20000 ? Math.round(subtotal * 0.1) : 0;
        message += `Subtotal: Rp${subtotal.toLocaleString("id-ID")}%0A`;
        if (discount > 0) {
          message += `Promo: -Rp${discount.toLocaleString("id-ID")}%0A`;
        }
        if (shippingPromoApplied) {
          message += `Shipping Promo: -Rp${shippingDiscount.toLocaleString("id-ID")}%0A`;
        }
        message += `Ongkos Kirim (${jarakKm} km): Rp${ongkir.toLocaleString(
          "id-ID"
        )}%0A`;
        message += `Total: Rp${(subtotal + ongkir - discount).toLocaleString("id-ID")}%0A`;
        if (catatan) {
          message += `Catatan: ${catatan}%0A`;
        }
        let alamat = document.getElementById("alamat-pengiriman").value.trim();
        if (alamat) {
          message += `Alamat Penerima: ${alamat}%0A`;
        }
        if (estimatedLocation) {
          message += `Lokasi: ${estimatedLocation}%0A`;
        }
        let phone = "6285183317960"; // Ganti dengan nomor WA kamu
        window.open(`https://wa.me/${phone}?text=${message}`, "_blank");
      }

      // Cetak Struk/Nota PNG
      function printNota() {
        if (cart.length === 0) {
          alert("Keranjang masih kosong!");
          return;
        }
        let nama = document.getElementById("nama-pembeli").value.trim();
        let catatan = document.getElementById("catatan-pembeli").value.trim();
        if (!nama) {
          alert("Masukkan nama pembeli terlebih dahulu!");
          return;
        }
        // Buat canvas 3:4 (misal 600x800 px)
        const width = 600,
          height = 900; // Tambah tinggi agar muat QRIS
        const canvas = document.createElement("canvas");
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext("2d");

        // Background putih
        ctx.fillStyle = "#fff";
        ctx.fillRect(0, 0, width, height);

        // Fungsi menggambar isi nota setelah logo & QRIS siap
        function drawNota(qrisImg, nama, catatan) {
          // Judul tengah atas
          ctx.font = "bold 32px Poppins, Arial";
          ctx.fillStyle = "#23251a";
          ctx.textAlign = "center";
          ctx.fillText("Ngaleueut", width / 2, 60);

          // Alamat booth
          ctx.font = "16px Poppins, Arial";
          ctx.fillStyle = "#23251a";
          ctx.fillText(
            "Blok Sukamaju, Desa Pasanggrahan, Kec. Maja",
            width / 2,
            90
          );

          // Tanggal & jam
          const now = new Date();
          const tanggal = now.toLocaleDateString("id-ID", {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric",
          });
          const jam = now.toLocaleTimeString("id-ID", {
            hour: "2-digit",
            minute: "2-digit",
          });
          ctx.font = "15px Poppins, Arial";
          ctx.fillText(`${tanggal} ${jam}`, width / 2, 120);

          let yOffset = 0;
          if (nama) {
            ctx.textAlign = "left";
            ctx.font = "16px Poppins, Arial";
            ctx.fillText(`Nama Pembeli: ${nama}`, 50, 140);
            yOffset = 20;
          }

          // Garis pemisah
          ctx.strokeStyle = "#23251a";
          ctx.beginPath();
          ctx.moveTo(40, 140 + yOffset);
          ctx.lineTo(width - 40, 140 + yOffset);
          ctx.stroke();

          // Cart items
          ctx.font = "16px Poppins, Arial";
          ctx.fillStyle = "#23251a";
          ctx.textAlign = "left";
          let y = 170 + yOffset;
          let subtotal = 0;
          let maxWidth = width - 100; // Max width for text, leaving space for price
          let itemNumber = 1;
          cart.forEach((item) => {
            let qtyText = `x${item.qty}`;
            let price = `Rp${(item.price * item.qty).toLocaleString("id-ID")}`;

            // First line: number. name [level] [variant] qty
            let firstLine = `${itemNumber}. ${item.name}`;
            if (item.level) {
              if (item.level === "6") {
                firstLine += " [dipisah]";
              } else {
                firstLine += ` [Level ${item.level}]`;
              }
            }
            if (item.variant) {
              firstLine += ` [${item.variant}]`;
            }
            firstLine += ` ${qtyText}`;
            ctx.fillText(firstLine, 50, y);
            ctx.textAlign = "right";
            ctx.fillText(price, width - 70, y);
            ctx.textAlign = "left";
            y += 28;

            // Additional lines: toppings, sauce, then for packages: choices and fixed
            let additionalLines = [];
            let toppingsText = "";
            if (item.toppings && item.toppings.length > 0) {
              if (item.id === 1 || item.id === 9 || item.id === 10) {
                toppingsText = `Toppings: ${item.toppings.map(t => `${t.name} x${t.qty}`).join(", ")}`;
              } else {
                toppingsText = `Toppings: ${item.toppings.join(", ")}`;
              }
              additionalLines.push(toppingsText);
            }
            let sauceText = "";
            if (item.sauce) {
              sauceText = `Sauce: ${item.sauce}`;
              additionalLines.push(sauceText);
            }
            // For packages, add choices and fixed below
            if (item.choices) {
              if (item.id === 2) {
                additionalLines.push(`Kuah: ${item.choices.kuah}`);
                additionalLines.push(`Metode: ${item.choices.method}`);
              } else if (item.id === 3) {
                additionalLines.push(`Kuah: ${item.choices.kuah}`);
              } else {
                for (let [k, v] of Object.entries(item.choices)) {
                  additionalLines.push(`${k}: ${v}`);
                }
              }
            }
            if (item.fixed) {
              for (let [k, v] of Object.entries(item.fixed)) {
                additionalLines.push(`${k}: ${v}`);
              }
            }
            additionalLines.forEach(line => {
              ctx.fillText(line, 50, y);
              y += 28;
            });

            itemNumber++;
            subtotal += item.price * item.qty;
          });

          // Garis subtotal
          ctx.strokeStyle = "#23251a";
          ctx.beginPath();
          ctx.moveTo(40, y + 10);
          ctx.lineTo(width - 40, y + 10);
          ctx.stroke();

          // Subtotal, promo, ongkir, total
          y += 40;
          ctx.font = "bold 17px Poppins, Arial";
          ctx.fillText("Subtotal", 50, y);
          ctx.textAlign = "right";
          ctx.fillText(`Rp${subtotal.toLocaleString("id-ID")}`, width - 50, y);
          ctx.textAlign = "left";
          y += 28;

          // Promo
          let discount = promoApplied && subtotal > 20000 ? Math.round(subtotal * 0.1) : 0;
          if (discount > 0) {
            ctx.font = "17px Poppins, Arial";
            ctx.fillStyle = "#009688";
            ctx.fillText("Promo", 50, y);
            ctx.textAlign = "right";
            ctx.fillText(`-Rp${discount.toLocaleString("id-ID")}`, width - 50, y);
            ctx.textAlign = "left";
            ctx.fillStyle = "#23251a";
            y += 28;
          }

          ctx.font = "17px Poppins, Arial";
          // Tampilkan ongkir beserta jarak
          ctx.fillText(`Ongkos Kirim (${jarakKm} km)`, 50, y);
          ctx.textAlign = "right";
          ctx.fillText(`Rp${ongkir.toLocaleString("id-ID")}`, width - 50, y);
          ctx.textAlign = "left";
          y += 28;
          ctx.font = "bold 19px Poppins, Arial";
          ctx.fillText("Total", 50, y);
          ctx.textAlign = "right";
          ctx.fillText(
            `Rp${(subtotal + ongkir - discount).toLocaleString("id-ID")}`,
            width - 50,
            y
          );
          ctx.textAlign = "left";


          // Tampilkan catatan jika ada
          if (catatan) {
            ctx.font = "16px Poppins, Arial";
            ctx.textAlign = "center";
            ctx.fillText(`Catatan: ${catatan}`, width / 2, y + 70);
            y += 30;
          }

          // Tampilkan alamat pengiriman jika ada
          let alamat = document.getElementById("alamat-pengiriman").value.trim();
          if (alamat) {
            ctx.font = "16px Poppins, Arial";
            ctx.textAlign = "center";
            ctx.fillText(`Alamat Penerima: ${alamat}`, width / 2, y + 70);
            y += 30;
          }

          // QRIS di tengah
          if (qrisImg) {
            // Ukuran QRIS 220x220 px, posisi tengah
            const qrisSize = 220;
            const qrisX = (width - qrisSize) / 2;
            const qrisY = y + 70;
            ctx.drawImage(qrisImg, qrisX, qrisY, qrisSize, qrisSize);

            // Label QRIS
            ctx.font = "bold 18px Poppins, Arial";
            ctx.fillStyle = "#23251a";
            ctx.textAlign = "center";
            ctx.fillText("Scan QRIS untuk pembayaran", width / 2, qrisY + qrisSize + 30);

            y = qrisY + qrisSize + 50;
          } else {
            y = y + 100;
          }

          // Ucapan terima kasih
          ctx.font = "italic 17px Poppins, Arial";
          ctx.fillStyle = "#23251a";
          ctx.textAlign = "center";
          ctx.fillText("Terima kasih atas pesanan Anda!", width / 2, y + 30);

          // Hormat kami pojok kanan bawah
          ctx.font = "15px Poppins, Arial";
          ctx.textAlign = "right";
          ctx.fillText("Hormat kami,", width - 40, height - 60);
          ctx.font = "bold 17px Poppins, Arial";
          ctx.fillText("Ngaleueut", width - 40, height - 35);

          // Download PNG
          const notaImg = canvas.toDataURL("image/png");
          const link = document.createElement("a");
          link.href = notaImg;
          link.download = "Nota-Ngaleueut-" + nama + ". "+ tanggal + ".png";
          link.click();
        }

        // Logo kiri atas (gunakan crossOrigin agar bisa tampil jika file logo support CORS)
        const logo = new window.Image();
        logo.crossOrigin = "anonymous";
        logo.src = "img/logo.png";
        logo.onload = function () {
          ctx.drawImage(logo, 30, 30, 70, 70);
          // Setelah logo, load QRIS
          loadQrisAndDraw();
        };
        logo.onerror = function () {
          // Jika gagal load logo, tetap lanjutkan tanpa logo
          loadQrisAndDraw();
        };

        function loadQrisAndDraw() {
          const qrisImg = new window.Image();
          qrisImg.crossOrigin = "anonymous";
          qrisImg.src = "img/qris.jpg";
          qrisImg.onload = function () {
            drawNota(qrisImg, nama, catatan);
          };
          qrisImg.onerror = function () {
            // Jika gagal load QRIS, tetap lanjutkan tanpa QRIS
            drawNota(null, nama, catatan);
          };
        }
      }

      // Tambahkan tombol cetak nota di bawah tombol WA
      window.addEventListener("DOMContentLoaded", function () {
        renderProducts();
        renderPromoForm();
        // Tambah event listener untuk checkbox delivery
        document.getElementById("delivery-checkbox").addEventListener("change", function() {
          const addressForm = document.getElementById("address-form");
          if (this.checked) {
            addressForm.style.display = "block";
          } else {
            addressForm.style.display = "none";
          }
        });
        // Tambah tombol cetak nota
        const btn = document.createElement("button");
        btn.className = "btn";
        btn.innerHTML = '<i class="fa fa-print" style="margin-right:6px;"></i>Cetak Nota';
        btn.style.marginLeft = "10px";
        btn.style.background = "#ff9800";
        btn.style.color = "#fff";
        btn.style.border = "2px solid #ff9800";
        btn.onmouseover = function () {
          btn.style.background = "#e65100";
          btn.style.borderColor = "#e65100";
        };
        btn.onmouseout = function () {
          btn.style.background = "#ff9800";
          btn.style.borderColor = "#ff9800";
        };
        btn.onclick = printNota;
        const cartDiv = document.querySelector(".cart");
        cartDiv.appendChild(btn);
      });

      // Map
      const map = L.map("map").setView(booth, 13);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
      }).addTo(map);
      L.marker(booth).addTo(map).bindPopup("Lokasi Booth").openPopup();
      let markerPembeli = null;

      // Daftar wilayah estimasi (nama, lat, lng, radius meter)
      const wilayahEstimasi = [
        { nama: "Dekat Blok Sukamaju", lat: -6.879, lng: 108.288, radius: 500 },
        { nama: "Dekat Desa Pasanggrahan", lat: -6.8805, lng: 108.287, radius: 1200 },
        { nama: "Dekat Kec. Maja", lat: -6.883, lng: 108.285, radius: 2500 },
        { nama: "Dekat Kab. Majalengka", lat: -6.836, lng: 108.227, radius: 10000 },
      ];

      // Fungsi hitung jarak 2 titik latlng (meter)
      function haversine(lat1, lng1, lat2, lng2) {
        const R = 6371000;
        const toRad = (d) => (d * Math.PI) / 180;
        const dLat = toRad(lat2 - lat1);
        const dLng = toRad(lng2 - lng1);
        const a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos(toRad(lat1)) *
        Math.cos(toRad(lat2)) *
        Math.sin(dLng / 2) *
        Math.sin(dLng / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }

      // Estimasi nama wilayah berdasar titik
      function estimasiWilayah(lat, lng) {
        for (let i = 0; i < wilayahEstimasi.length; i++) {
          const w = wilayahEstimasi[i];
          const dist = haversine(lat, lng, w.lat, w.lng);
          if (dist <= w.radius) return w.nama;
        }
        return "Sekitar Majalengka";
      }

      // Fungsi hitung ongkir sesuai tarif bertingkat
      function hitungOngkir(jarakKm, subtotal) {
        let ongkir = 0;
        if (jarakKm <= 15) {
          ongkir = Math.round(jarakKm * (subtotal > 50000 ? 1500 : 2000));
        } else if (jarakKm > 15 && jarakKm <= 20) {
          ongkir = Math.round(jarakKm * 5000);
        } else {
          ongkir = Math.round(jarakKm * 10000);
        }
        return ongkir;
      }

      map.on("click", function (e) {
        const pembeli = [e.latlng.lat, e.latlng.lng];
        if (markerPembeli) map.removeLayer(markerPembeli);
        markerPembeli = L.marker(pembeli)
          .addTo(map)
          .bindPopup("Lokasi Pembeli")
          .openPopup();
        const url = `https://router.project-osrm.org/route/v1/driving/${booth[1]},${booth[0]};${pembeli[1]},${pembeli[0]}?overview=false`;
        fetch(url)
          .then((res) => res.json())
          .then((data) => {
        if (data.routes && data.routes.length > 0) {
          const jarakMeter = data.routes[0].distance;
          jarakKm = (jarakMeter / 1000).toFixed(2);

          // Hitung subtotal
          let subtotal = cart.reduce((sum, item) => sum + item.price * item.qty, 0);

          // Hitung ongkir dengan tarif bertingkat
          ongkir = hitungOngkir(Number(jarakKm), subtotal);

          // Estimasi nama wilayah
          estimatedLocation = estimasiWilayah(pembeli[0], pembeli[1]);

          document.getElementById(
            "hasil"
          ).innerHTML = `Jarak: <b>${jarakKm} km</b><br>Ongkos Kirim: <b>Rp ${ongkir.toLocaleString()}</b><br>Wilayah: <b>${estimatedLocation}</b>`;
          renderCart();
        } else {
          document.getElementById("hasil").innerText =
            "Gagal menghitung jarak.";
          estimatedLocation = "";
        }
          })
          .catch((err) => {
        console.error(err);
        document.getElementById("hasil").innerText =
          "Error mengambil data OSRM.";
        estimatedLocation = "";
          });
      });
    </script>
  </body>
</html>
